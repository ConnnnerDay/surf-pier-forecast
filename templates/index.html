<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ forecast.location_name or 'Fishing Forecast' }} &mdash; Surf &amp; Pier Forecast</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#0e5f78">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.svg') }}">
    <script>
    // Apply saved theme immediately to prevent flash
    (function() {
        var t = localStorage.getItem('theme');
        if (t === 'dark' || (!t && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
    })();
    </script>
    <meta name="description" content="Surf and pier fishing forecast with real-time conditions, species rankings, tide charts, and solunar times for {{ forecast.location_name or 'your location' }}">
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="{{ forecast.conditions.verdict }} — {{ forecast.location_name or 'Fishing Forecast' }}">
    <meta property="og:description" content="Water {{ forecast.conditions.water_temp_f }}°F | Wind {{ forecast.conditions.wind }} | Waves {{ forecast.conditions.waves }}{% if forecast.species %} | Top: {{ forecast.species[0].name }}{% endif %}">
    <meta property="og:image" content="{{ url_for('static', filename='icons/icon-192.svg', _external=True) }}">
    {% if share_id %}<meta property="og:url" content="{{ url_for('shared_forecast', location_id=share_id, _external=True) }}">{% endif %}
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="{{ forecast.conditions.verdict }} — {{ forecast.location_name or 'Fishing Forecast' }}">
    <meta name="twitter:description" content="Water {{ forecast.conditions.water_temp_f }}°F | Wind {{ forecast.conditions.wind }} | Waves {{ forecast.conditions.waves }}">
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <header role="banner">
        <div class="header-inner">
            <div class="header-top-row">
                <h1>Surf &amp; Pier Fishing Outlook</h1>
                <button class="unit-toggle" id="unit-toggle" onclick="toggleUnits()" title="Toggle °F / °C" aria-label="Toggle temperature units">
                    <span class="unit-label" id="unit-label">°F</span>
                </button>
                <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode" aria-label="Toggle dark mode">
                    <svg class="theme-icon theme-icon--light" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    <svg class="theme-icon theme-icon--dark" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
            </div>
            <p class="subtitle">{{ forecast.location_name or 'Wrightsville Beach &amp; Carolina Beach, NC' }}</p>
            <div class="header-actions">
                <button class="fav-toggle" id="fav-toggle" onclick="toggleFavorite()" title="Save to favorites" aria-label="Save to favorites">
                    <svg class="fav-icon fav-icon--off" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                    <svg class="fav-icon fav-icon--on" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                </button>
                <a href="{{ url_for('setup') }}" class="change-location">Change location</a>
            </div>
            <div class="favorites-bar" id="favorites-bar"></div>
            {% if cached %}
            <div class="banner">Cached forecast from {{ forecast.generated_at }}</div>
            {% endif %}
        </div>
    </header>

    <main id="main-content" role="main">
        <!-- Weather Alerts -->
        {% if forecast.alerts %}
        <div class="alerts-banner" role="alert" aria-label="Weather alerts">
            {% for alert in forecast.alerts %}
            <div class="alert-item alert-{{ alert.severity|lower }}">
                <div class="alert-icon">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </div>
                <div class="alert-body">
                    <strong class="alert-event">{{ alert.event }}</strong>
                    <span class="alert-headline">{{ alert.headline }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Verdict hero -->
        <section class="verdict-hero">
            <div class="verdict-badge verdict-{{ forecast.conditions.verdict|lower|replace(' ', '-') }}">
                {{ forecast.conditions.verdict }}
            </div>
            <p class="verdict-sub">24-hour fishability outlook</p>
            {% if forecast.pressure %}
            <p class="pressure-note" title="{{ forecast.pressure.fishing_impact }}">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l2 2"/></svg>
                Barometer {{ forecast.pressure.pressure_inhg }}" {{ forecast.pressure.trend|lower }}
            </p>
            {% endif %}
        </section>

        <!-- Best Fishing Times -->
        {% if forecast.best_times %}
        <section class="best-times-section">
            <h2>
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-4px; margin-right:0.3rem;">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                When to Fish
            </h2>
            <div class="best-times-cards">
                {% for bt in forecast.best_times %}
                <div class="best-time-card best-time--{{ bt.quality|lower }}">
                    <div class="bt-quality">{{ bt.quality }}</div>
                    <div class="bt-window">{{ bt.window }}</div>
                    <div class="bt-reason">{{ bt.reason }}</div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Conditions grid -->
        <section class="conditions-section">
            <h2>Marine Conditions</h2>
            <div class="stat-grid">
                <div class="stat-card">
                    <span class="stat-label">Wind</span>
                    <span class="stat-value">{{ forecast.conditions.wind }}</span>
                    <span class="stat-detail">next 24 h</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Waves</span>
                    <span class="stat-value">{{ forecast.conditions.waves }}</span>
                    <span class="stat-detail">next 24 h</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Water Temp</span>
                    <span class="stat-value">
                        <span class="unit-temp" data-f="{{ forecast.conditions.water_temp_f }}">{{ forecast.conditions.water_temp_f }}&deg;F</span>
                        {% if forecast.conditions.water_temp_trend == 'warming' %}
                        <svg class="temp-trend-icon" viewBox="0 0 16 16" width="14" height="14"><path d="M8 3l4 5H4z" fill="#e05830"/></svg>
                        {% elif forecast.conditions.water_temp_trend == 'cooling' %}
                        <svg class="temp-trend-icon" viewBox="0 0 16 16" width="14" height="14"><path d="M8 13l4-5H4z" fill="#2980b9"/></svg>
                        {% elif forecast.conditions.water_temp_trend == 'stable' %}
                        <svg class="temp-trend-icon" viewBox="0 0 16 16" width="14" height="14"><rect x="2" y="7" width="12" height="2" rx="1" fill="#6b7b8d"/></svg>
                        {% endif %}
                    </span>
                    <span class="stat-detail" title="{{ forecast.conditions.water_temp_trend_detail }}">{% if forecast.conditions.water_temp_live %}live reading{% else %}monthly avg{% endif %}{% if forecast.conditions.water_temp_trend %} &middot; {{ forecast.conditions.water_temp_trend }}{% endif %}</span>
                </div>
                {% if forecast.conditions.wind_dir %}
                <div class="stat-card stat-card--compass">
                    <span class="stat-label">Direction</span>
                    <div class="wind-compass">
                        <svg class="compass-svg" viewBox="0 0 80 80" width="56" height="56">
                            <circle cx="40" cy="40" r="36" fill="none" stroke="#d1d9e0" stroke-width="1.5"/>
                            <text x="40" y="10" text-anchor="middle" font-size="7" font-weight="600" fill="#6b7b8d">N</text>
                            <text x="72" y="43" text-anchor="middle" font-size="7" font-weight="600" fill="#6b7b8d">E</text>
                            <text x="40" y="76" text-anchor="middle" font-size="7" font-weight="600" fill="#6b7b8d">S</text>
                            <text x="8" y="43" text-anchor="middle" font-size="7" font-weight="600" fill="#6b7b8d">W</text>
                            {% set dir_degrees = {
                                'N': 0, 'NNE': 22.5, 'NE': 45, 'ENE': 67.5,
                                'E': 90, 'ESE': 112.5, 'SE': 135, 'SSE': 157.5,
                                'S': 180, 'SSW': 202.5, 'SW': 225, 'WSW': 247.5,
                                'W': 270, 'WNW': 292.5, 'NW': 315, 'NNW': 337.5
                            } %}
                            <g transform="rotate({{ dir_degrees.get(forecast.conditions.wind_dir, 0) }}, 40, 40)">
                                <polygon points="40,12 35,40 40,36 45,40" fill="#e05830" stroke="#c0392b" stroke-width="0.5"/>
                                <polygon points="40,68 35,40 40,44 45,40" fill="#d1d9e0" stroke="#b0bec5" stroke-width="0.5"/>
                            </g>
                            <circle cx="40" cy="40" r="3" fill="#e05830"/>
                        </svg>
                    </div>
                    <span class="stat-detail">{{ forecast.conditions.wind_dir }} wind</span>
                </div>
                {% else %}
                <div class="stat-card">
                    <span class="stat-label">Sun</span>
                    <span class="stat-value">{{ forecast.conditions.sunrise_sunset }}</span>
                    <span class="stat-detail">sunrise / sunset</span>
                </div>
                {% endif %}
                {% if forecast.conditions.wind_dir %}
                <div class="stat-card">
                    <span class="stat-label">Sun</span>
                    <span class="stat-value">{{ forecast.conditions.sunrise_sunset }}</span>
                    <span class="stat-detail">sunrise / sunset</span>
                </div>
                {% endif %}
                {% if forecast.tide_state %}
                <div class="stat-card">
                    <span class="stat-label">Tide</span>
                    <span class="stat-value">
                        {% if forecast.tide_state == 'Rising' %}
                        <svg viewBox="0 0 20 20" width="16" height="16" style="vertical-align:-2px; margin-right:0.2rem;"><path d="M10 4l5 6H5z" fill="var(--ocean)"/></svg>
                        {% else %}
                        <svg viewBox="0 0 20 20" width="16" height="16" style="vertical-align:-2px; margin-right:0.2rem;"><path d="M10 16l5-6H5z" fill="var(--amber)"/></svg>
                        {% endif %}
                        {{ forecast.tide_state }}
                    </span>
                    <span class="stat-detail">current tidal flow</span>
                </div>
                {% endif %}
                {% if forecast.pressure %}
                <div class="stat-card">
                    <span class="stat-label">Pressure</span>
                    <span class="stat-value">
                        {{ forecast.pressure.pressure_inhg }}"
                        {% if forecast.pressure.trend == 'Rising' %}
                        <svg class="temp-trend-icon" viewBox="0 0 16 16" width="12" height="12"><path d="M8 3l4 5H4z" fill="#27ae60"/></svg>
                        {% elif forecast.pressure.trend == 'Falling' %}
                        <svg class="temp-trend-icon" viewBox="0 0 16 16" width="12" height="12"><path d="M8 13l4-5H4z" fill="#e05830"/></svg>
                        {% else %}
                        <svg class="temp-trend-icon" viewBox="0 0 16 16" width="12" height="12"><rect x="2" y="7" width="12" height="2" rx="1" fill="#6b7b8d"/></svg>
                        {% endif %}
                    </span>
                    <span class="stat-detail" title="{{ forecast.pressure.fishing_impact }}">{{ forecast.pressure.trend|lower }} &middot; {{ forecast.pressure.pressure_mb }} mb</span>
                </div>
                {% endif %}
                {% if forecast.weather %}
                <div class="stat-card">
                    <span class="stat-label">Air Temp</span>
                    <span class="stat-value"><span class="unit-temp" data-f="{{ forecast.weather.air_temp_f }}">{{ forecast.weather.air_temp_f }}&deg;F</span></span>
                    <span class="stat-detail">
                        {% if forecast.weather.description %}{{ forecast.weather.description|lower }}{% endif %}
                        {% if forecast.weather.humidity %} &middot; {{ forecast.weather.humidity|int }}% humidity{% endif %}
                    </span>
                </div>
                {% if forecast.weather.feels_like_f or forecast.weather.wind_chill_f %}
                <div class="stat-card">
                    <span class="stat-label">Feels Like</span>
                    <span class="stat-value"><span class="unit-temp" data-f="{{ (forecast.weather.feels_like_f or forecast.weather.wind_chill_f)|round|int }}">{{ (forecast.weather.feels_like_f or forecast.weather.wind_chill_f)|round|int }}&deg;F</span></span>
                    <span class="stat-detail">{% if forecast.weather.feels_like_f %}heat index{% else %}wind chill{% endif %}</span>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </section>

        <!-- Spot Tips -->
        {% if forecast.spot_tips %}
        <section class="spot-tips-section">
            <h2>
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-3px; margin-right:0.3rem;">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                </svg>
                Today's Fishing Tips
            </h2>
            <div class="spot-tips-list">
                {% for tip in forecast.spot_tips %}
                <div class="spot-tip">
                    <div class="spot-tip-icon">
                        {% if tip.icon == 'wind' %}
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                        {% elif tip.icon == 'waves' %}
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12c2-3 4-5 6-5s4 5 6 5 4-5 6-5"/><path d="M2 17c2-3 4-5 6-5s4 5 6 5 4-5 6-5"/></svg>
                        {% elif tip.icon == 'tide' %}
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h4l3-9 4 18 3-9h6"/></svg>
                        {% elif tip.icon == 'time' %}
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        {% elif tip.icon == 'season' %}
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        {% endif %}
                    </div>
                    <div class="spot-tip-body">
                        <strong class="spot-tip-title">{{ tip.title }}</strong>
                        <p class="spot-tip-detail">{{ tip.detail }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Tide predictions -->
        {% if forecast.tides %}
        <section class="tide-section">
            <h2>Today's Tides</h2>
            <p class="section-sub">High &amp; low tide times from NOAA predictions</p>
            <div class="tide-timeline">
                {% for tide in forecast.tides %}
                <div class="tide-point tide-{{ tide.type|lower }}">
                    <div class="tide-type-icon">
                        {% if tide.type == 'High' %}
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M2 12c2-3 4-5 6-5s4 5 6 5 4-5 6-5"/>
                            <path d="M2 17c2-3 4-5 6-5s4 5 6 5 4-5 6-5"/>
                        </svg>
                        {% else %}
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M2 14c2-2 4-3 6-3s4 3 6 3 4-3 6-3"/>
                        </svg>
                        {% endif %}
                    </div>
                    <div class="tide-info">
                        <span class="tide-type">{{ tide.type }}</span>
                        <span class="tide-time">{{ tide.time }}</span>
                    </div>
                    <span class="tide-height">{{ tide.height_ft }} ft</span>
                </div>
                {% endfor %}
            </div>

            {% if forecast.tide_chart %}
            {% set chart = forecast.tide_chart|tojson|safe %}
            <div class="tide-chart-wrap" id="tide-chart-wrap">
                <div class="tide-chart" id="tide-chart"></div>
            </div>
            <script>
            (function() {
                var data = JSON.parse({{ chart }});
                var svg = '<svg viewBox="' + data.viewBox + '" preserveAspectRatio="xMidYMid meet" class="tide-chart-svg">';
                svg += '<defs><linearGradient id="tg" x1="0" y1="0" x2="0" y2="1">';
                svg += '<stop offset="0%" stop-color="var(--ocean)" stop-opacity="0.15"/>';
                svg += '<stop offset="100%" stop-color="var(--ocean)" stop-opacity="0.02"/>';
                svg += '</linearGradient></defs>';
                svg += '<path d="' + data.fill_path + '" fill="url(#tg)"/>';
                svg += '<path d="' + data.path + '" fill="none" stroke="var(--ocean)" stroke-width="2.5" stroke-linecap="round"/>';
                data.markers.forEach(function(m) {
                    var col = m.type === 'High' ? 'var(--ocean)' : 'var(--sea-green)';
                    svg += '<circle cx="' + m.cx + '" cy="' + m.cy + '" r="5" fill="' + col + '" stroke="#fff" stroke-width="2"/>';
                    var anchor = parseFloat(m.cx) > data.width / 2 ? 'end' : 'start';
                    var dx = anchor === 'end' ? -8 : 8;
                    svg += '<text x="' + (parseFloat(m.cx) + dx) + '" y="' + (parseFloat(m.cy) - 10) + '" text-anchor="' + anchor + '" class="tide-chart-label">' + m.time + '</text>';
                    svg += '<text x="' + (parseFloat(m.cx) + dx) + '" y="' + (parseFloat(m.cy) - 22) + '" text-anchor="' + anchor + '" class="tide-chart-height">' + m.height + ' ft</text>';
                });
                svg += '</svg>';
                document.getElementById('tide-chart').innerHTML = svg;
            })();
            </script>
            {% endif %}
        </section>
        {% endif %}

        <!-- Solunar fishing times -->
        {% if forecast.solunar %}
        <section class="solunar-section">
            <div class="solunar-header">
                <div>
                    <h2>Best Fishing Times</h2>
                    <p class="section-sub">Solunar forecast &mdash; {{ forecast.solunar.rating }} day</p>
                </div>
                <div class="moon-phase-badge">
                    <svg class="moon-icon" viewBox="0 0 40 40" width="36" height="36">
                        {% set phase = forecast.solunar.moon_phase %}
                        {% if 'New' in phase %}
                        <circle cx="20" cy="20" r="17" fill="#2c3e50" stroke="#6b7b8d" stroke-width="1"/>
                        {% elif 'Full' in phase %}
                        <circle cx="20" cy="20" r="17" fill="#fef9e7" stroke="#d4920b" stroke-width="1"/>
                        {% elif 'Waxing Crescent' in phase %}
                        <circle cx="20" cy="20" r="17" fill="#2c3e50" stroke="#6b7b8d" stroke-width="1"/>
                        <path d="M20,3 A17,17 0 0,1 20,37 A10,17 0 0,0 20,3" fill="#fef9e7"/>
                        {% elif 'First Quarter' in phase %}
                        <circle cx="20" cy="20" r="17" fill="#2c3e50" stroke="#6b7b8d" stroke-width="1"/>
                        <path d="M20,3 A17,17 0 0,1 20,37 A0,17 0 0,0 20,3" fill="#fef9e7"/>
                        {% elif 'Waxing Gibbous' in phase %}
                        <circle cx="20" cy="20" r="17" fill="#fef9e7" stroke="#d4920b" stroke-width="1"/>
                        <path d="M20,3 A17,17 0 0,0 20,37 A10,17 0 0,1 20,3" fill="#2c3e50"/>
                        {% elif 'Waning Gibbous' in phase %}
                        <circle cx="20" cy="20" r="17" fill="#fef9e7" stroke="#d4920b" stroke-width="1"/>
                        <path d="M20,3 A17,17 0 0,1 20,37 A10,17 0 0,0 20,3" fill="#2c3e50"/>
                        {% elif 'Last Quarter' in phase %}
                        <circle cx="20" cy="20" r="17" fill="#2c3e50" stroke="#6b7b8d" stroke-width="1"/>
                        <path d="M20,3 A17,17 0 0,0 20,37 A0,17 0 0,1 20,3" fill="#fef9e7"/>
                        {% elif 'Waning Crescent' in phase %}
                        <circle cx="20" cy="20" r="17" fill="#2c3e50" stroke="#6b7b8d" stroke-width="1"/>
                        <path d="M20,3 A17,17 0 0,0 20,37 A10,17 0 0,1 20,3" fill="#fef9e7"/>
                        {% endif %}
                    </svg>
                    <span class="moon-label">{{ forecast.solunar.moon_phase }}</span>
                </div>
            </div>

            <div class="solunar-grid">
                <!-- Major periods -->
                {% for period in forecast.solunar.major_periods %}
                <div class="solunar-card solunar-major">
                    <div class="solunar-icon">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                    </div>
                    <div class="solunar-info">
                        <span class="solunar-label">Major Period</span>
                        <span class="solunar-times">{{ period.start }} &ndash; {{ period.end }}</span>
                    </div>
                </div>
                {% endfor %}

                <!-- Minor periods -->
                {% for period in forecast.solunar.minor_periods %}
                <div class="solunar-card solunar-minor">
                    <div class="solunar-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                    <div class="solunar-info">
                        <span class="solunar-label">Minor Period</span>
                        <span class="solunar-times">{{ period.start }} &ndash; {{ period.end }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Species ranking -->
        <section class="species-section">
            <h2>What's Biting Now</h2>
            <p class="section-sub">Top {{ forecast.species|length }} based on current conditions</p>
            <div class="species-cards">
                {% for sp in forecast.species %}
                <div class="species-card">
                    <div class="species-rank-area">
                        <div class="species-rank">#{{ sp.rank }}</div>
                        <span class="activity-badge activity-{{ sp.activity|lower }}">{{ sp.activity }}</span>
                    </div>
                    <div class="species-body">
                        <h3>{{ sp.name }}</h3>
                        <p class="species-why">{{ sp.explanation }}</p>
                        {% if sp.tip %}
                        <p class="species-tip">
                            <svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px; margin-right:0.2rem; flex-shrink:0;"><path d="M9 18h6M10 22h4M12 2a7 7 0 0 0-4 12.7V17h8v-2.3A7 7 0 0 0 12 2z"/></svg>
                            {{ sp.tip }}
                        </p>
                        {% endif %}
                        <div class="species-score-bar">
                            <div class="score-track">
                                <div class="score-fill score-fill--{{ sp.activity|lower }}" style="width: {{ sp.score }}%"></div>
                            </div>
                            <span class="score-label">{{ sp.score }}/100</span>
                        </div>
                        <div class="species-meta">
                            <div class="meta-item meta-item--bait">
                                <span class="meta-label">Bait</span>
                                <span class="meta-value">{{ sp.bait }}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Rig</span>
                                <span class="meta-value">{{ sp.rig }}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Hook</span>
                                <span class="meta-value">{{ sp.hook_size }}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Sinker</span>
                                <span class="meta-value">{{ sp.sinker }}</span>
                            </div>
                        </div>
                        {% if sp.regulation %}
                        <div class="species-regs">
                            <div class="regs-header">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                </svg>
                                <span>Regulations</span>
                            </div>
                            <div class="regs-grid">
                                {% if sp.regulation.min_size %}
                                <div class="reg-item">
                                    <span class="reg-label">Min Size</span>
                                    <span class="reg-value">{{ sp.regulation.min_size }}</span>
                                </div>
                                {% endif %}
                                {% if sp.regulation.bag_limit %}
                                <div class="reg-item">
                                    <span class="reg-label">Bag Limit</span>
                                    <span class="reg-value">{{ sp.regulation.bag_limit }}</span>
                                </div>
                                {% endif %}
                                {% if sp.regulation.season %}
                                <div class="reg-item">
                                    <span class="reg-label">Season</span>
                                    <span class="reg-value">{{ sp.regulation.season }}</span>
                                </div>
                                {% endif %}
                                {% if sp.regulation.notes %}
                                <div class="reg-item reg-item--full">
                                    <span class="reg-value reg-note">{{ sp.regulation.notes }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Recommended Rigs -->
        {% if forecast.rig_recommendations %}
        <section class="rig-section">
            <h2>Recommended Rigs</h2>
            <p class="section-sub">Matched to species biting now</p>
            <div class="rig-cards">
                {% for rig in forecast.rig_recommendations %}
                <div class="rig-card">
                    <h3>{{ rig.name }}</h3>
                    {% if rig.image %}
                    <div class="rig-diagram">
                        <img src="{{ url_for('static', filename=rig.image) }}" alt="{{ rig.name }} diagram" loading="lazy">
                    </div>
                    {% endif %}
                    <p class="rig-desc">{{ rig.description }}</p>
                    <div class="rig-targets">
                        <span class="rig-targets-label">Good for:</span>
                        {% for t in rig.targets %}
                        <span class="rig-target-tag">{{ t }}</span>
                        {% endfor %}
                    </div>
                    <dl class="rig-specs">
                        <dt>Mainline</dt><dd>{{ rig.mainline }}</dd>
                        <dt>Leader</dt><dd>{{ rig.leader }}</dd>
                        <dt>Hook</dt><dd>{{ rig.hook }}</dd>
                        <dt>Sinker</dt><dd>{{ rig.sinker }}</dd>
                    </dl>
                    {% if rig.knots %}
                    <div class="rig-knots">
                        <h4 class="rig-knots-title">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-2px; margin-right:0.25rem;">
                                <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2"/>
                                <path d="M8 12s1.5-2 4-2 4 2 4 2"/>
                                <path d="M8 12s1.5 2 4 2 4-2 4-2"/>
                            </svg>
                            Recommended Knots
                        </h4>
                        {% for knot in rig.knots %}
                        <details class="knot-detail">
                            <summary>
                                <strong>{{ knot.name }}</strong>
                                <span class="knot-strength">{{ knot.strength }}</span>
                                <span class="knot-use">{{ knot.use }}</span>
                            </summary>
                            <p class="knot-steps">{{ knot.steps }}</p>
                        </details>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Bait recommendations -->
        <section class="bait-section">
            <h2>Natural Bait Recommendations</h2>
            <div class="bait-list">
                {% for item in forecast.bait_rankings %}
                <div class="bait-item">
                    <span class="bait-num">{{ loop.index }}</span>
                    <div class="bait-info">
                        <strong>{{ item.bait }}</strong>
                        <span>{{ item.notes }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Natural Bait in the Water -->
        {% if forecast.natural_bait %}
        <section class="forage-section">
            <h2>
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-3px; margin-right:0.3rem;">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 12h8M12 8v8"/>
                </svg>
                What's in the Water
            </h2>
            <p class="section-sub">Natural forage species this month — match your bait</p>
            <div class="forage-grid">
                {% for bait in forecast.natural_bait %}
                {% if bait.status == 'available' %}
                <div class="forage-item">
                    <div class="forage-status">
                        <svg viewBox="0 0 16 16" width="12" height="12"><circle cx="8" cy="8" r="6" fill="var(--sea-green)"/></svg>
                    </div>
                    <div class="forage-info">
                        <strong class="forage-name">{{ bait.name }}</strong>
                        <span class="forage-note">{{ bait.note }}</span>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- 3-Day Outlook -->
        {% if forecast.outlook %}
        <section class="outlook-section">
            <h2>3-Day Outlook</h2>
            <p class="section-sub">Upcoming conditions forecast</p>
            <div class="outlook-grid">
                {% for day in forecast.outlook %}
                <div class="outlook-card">
                    <div class="outlook-header">
                        <span class="outlook-day">{{ day.day }}</span>
                        <span class="outlook-date">{{ day.date }}</span>
                    </div>
                    <div class="outlook-verdict verdict-badge verdict-{{ day.verdict|lower|replace(' ', '-') }}">
                        {{ day.verdict }}
                    </div>
                    <div class="outlook-details">
                        <div class="outlook-detail">
                            <span class="outlook-detail-label">Wind</span>
                            <span class="outlook-detail-value">{{ day.wind }}</span>
                        </div>
                        <div class="outlook-detail">
                            <span class="outlook-detail-label">Waves</span>
                            <span class="outlook-detail-value">{{ day.waves }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Species Availability Calendar -->
        {% if forecast.calendar %}
        <section class="calendar-section">
            <h2>Species Calendar</h2>
            <p class="section-sub">Monthly availability at {{ forecast.location_name or 'this location' }}</p>
            <div class="calendar-table-wrap">
                <table class="calendar-table">
                    <thead>
                        <tr>
                            <th class="cal-species-col">Species</th>
                            {% for m in ['J','F','M','A','M','J','J','A','S','O','N','D'] %}
                            <th class="cal-month-col">{{ m }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for sp in forecast.calendar %}
                        <tr>
                            <td class="cal-species-name">{{ sp.name }}</td>
                            {% for mo in sp.months %}
                            <td>
                                {% if mo.level == 'peak' %}
                                <span class="cal-dot cal-dot--peak" title="{{ mo.abbr }}: Peak season"></span>
                                {% elif mo.level == 'good' %}
                                <span class="cal-dot cal-dot--good" title="{{ mo.abbr }}: Good season"></span>
                                {% else %}
                                <span class="cal-dot cal-dot--off" title="{{ mo.abbr }}: Off season"></span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="calendar-legend">
                <span class="cal-legend-item"><span class="cal-dot cal-dot--peak"></span> Peak</span>
                <span class="cal-legend-item"><span class="cal-dot cal-dot--good"></span> Good</span>
                <span class="cal-legend-item"><span class="cal-dot cal-dot--off"></span> Off season</span>
            </div>
        </section>
        {% endif %}

        <!-- Fishing Log -->
        <section class="fishlog-section">
            <h2>
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-3px; margin-right:0.3rem;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                Fishing Log
            </h2>
            <p class="section-sub">Track your catches — saved on this device</p>

            <div class="fishlog-form" id="fishlog-form" role="form" aria-label="Add a catch to your fishing log">
                <div class="fishlog-row">
                    <label for="log-species" class="sr-only">Species caught</label>
                    <input type="text" id="log-species" placeholder="Species caught" class="fishlog-input" maxlength="60" autocomplete="off">
                    <label for="log-size" class="sr-only">Size</label>
                    <input type="text" id="log-size" placeholder="Size (optional)" class="fishlog-input fishlog-input--sm" maxlength="20" autocomplete="off">
                </div>
                <div class="fishlog-row">
                    <label for="log-notes" class="sr-only">Notes</label>
                    <input type="text" id="log-notes" placeholder="Notes (bait used, location, etc.)" class="fishlog-input" maxlength="200" autocomplete="off">
                    <button class="fishlog-add-btn" onclick="addLogEntry()" aria-label="Add catch entry">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add
                    </button>
                </div>
            </div>

            <div class="fishlog-entries" id="fishlog-entries" aria-live="polite"></div>
            <div class="fishlog-empty" id="fishlog-empty" style="display:none;">
                <p>No catches logged yet. Record your first catch above!</p>
            </div>

            <div class="catch-stats" id="catch-stats" style="display:none;">
                <div class="catch-stats-grid">
                    <div class="catch-stat">
                        <span class="catch-stat-value" id="stat-total">0</span>
                        <span class="catch-stat-label">Total Catches</span>
                    </div>
                    <div class="catch-stat">
                        <span class="catch-stat-value" id="stat-species">0</span>
                        <span class="catch-stat-label">Species</span>
                    </div>
                    <div class="catch-stat">
                        <span class="catch-stat-value" id="stat-top">—</span>
                        <span class="catch-stat-label">Most Caught</span>
                    </div>
                    <div class="catch-stat">
                        <span class="catch-stat-value" id="stat-recent">—</span>
                        <span class="catch-stat-label">Last Catch</span>
                    </div>
                </div>
                <button class="fishlog-export-btn" onclick="exportLogCSV()" title="Download catches as CSV">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export CSV
                </button>
            </div>
        </section>

        <!-- Share & Refresh -->
        <section class="share-section">
            <h2>Share This Forecast</h2>
            <div class="share-buttons">
                <button class="share-btn share-btn--link" onclick="shareLink()" title="Copy shareable link">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                    </svg>
                    <span>Copy Link</span>
                </button>
                <button class="share-btn share-btn--text" onclick="shareText()" title="Copy forecast summary">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M7 7h10M7 12h10M7 17h6"/>
                    </svg>
                    <span>Copy Summary</span>
                </button>
                <button class="share-btn share-btn--print" onclick="window.print()" title="Print forecast">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 6 2 18 2 18 9"/>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                        <rect x="6" y="14" width="12" height="8"/>
                    </svg>
                    <span>Print Forecast</span>
                </button>
            </div>
            <div id="share-toast" class="share-toast" style="display:none;" role="status" aria-live="polite">Copied!</div>
        </section>

        <section class="refresh">
            <form method="post" action="{{ url_for('api_refresh') }}">
                <button type="submit">Refresh Forecast</button>
            </form>
            <p class="timestamp">
                Updated {{ forecast.age_human if forecast.age_human else forecast.generated_at }}
                <span id="auto-refresh-note"></span>
            </p>
        </section>
    </main>

    <footer>
        <p>&copy; {{ forecast.generated_at[:4] }} Surf &amp; Pier Fishing Outlook &mdash; {{ forecast.location_name or 'Wrightsville Beach &amp; Carolina Beach, NC' }}</p>
    </footer>

    <script>
    /* ---- Favorite Locations (localStorage) ---- */
    var FAV_KEY = 'favorite_locations';
    var CURRENT_LOC_ID = {{ (forecast.location_id or '')|tojson }};
    var CURRENT_LOC_NAME = {{ (forecast.location_name or '')|tojson }};

    function getFavorites() {
        try { return JSON.parse(localStorage.getItem(FAV_KEY)) || []; }
        catch(e) { return []; }
    }

    function saveFavorites(favs) {
        localStorage.setItem(FAV_KEY, JSON.stringify(favs));
    }

    function isFavorite() {
        return getFavorites().some(function(f) { return f.id === CURRENT_LOC_ID; });
    }

    function toggleFavorite() {
        var favs = getFavorites();
        var idx = favs.findIndex(function(f) { return f.id === CURRENT_LOC_ID; });
        if (idx >= 0) {
            favs.splice(idx, 1);
        } else {
            favs.push({ id: CURRENT_LOC_ID, name: CURRENT_LOC_NAME });
            if (favs.length > 8) favs = favs.slice(-8);
        }
        saveFavorites(favs);
        renderFavorites();
    }

    function renderFavorites() {
        var favs = getFavorites();
        var isFav = isFavorite();
        var toggle = document.getElementById('fav-toggle');
        if (toggle) {
            toggle.classList.toggle('fav-toggle--active', isFav);
        }
        var bar = document.getElementById('favorites-bar');
        if (!bar) return;
        if (favs.length === 0) { bar.innerHTML = ''; return; }
        var html = '';
        favs.forEach(function(f) {
            var active = f.id === CURRENT_LOC_ID ? ' fav-chip--active' : '';
            var shortName = f.name.split(',')[0];
            html += '<a href="/f/' + encodeURIComponent(f.id) + '" class="fav-chip' + active + '">' + esc(shortName) + '</a>';
        });
        bar.innerHTML = html;
    }

    renderFavorites();

    function toggleTheme() {
        var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        if (isDark) {
            document.documentElement.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
        } else {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
        }
    }

    // Unit toggle (°F ↔ °C)
    function applyUnits(unit) {
        var label = document.getElementById('unit-label');
        var els = document.querySelectorAll('.unit-temp');
        els.forEach(function(el) {
            var f = parseFloat(el.getAttribute('data-f'));
            if (isNaN(f)) return;
            if (unit === 'C') {
                var c = Math.round((f - 32) * 5 / 9);
                el.innerHTML = c + '&deg;C';
            } else {
                el.innerHTML = Math.round(f) + '&deg;F';
            }
        });
        if (label) label.textContent = '°' + unit;
    }

    function toggleUnits() {
        var current = localStorage.getItem('units') || 'F';
        var next = current === 'F' ? 'C' : 'F';
        localStorage.setItem('units', next);
        applyUnits(next);
    }

    // Apply saved unit preference
    (function() {
        var u = localStorage.getItem('units');
        if (u === 'C') applyUnits('C');
    })();

    function showToast(msg) {
        var t = document.getElementById('share-toast');
        t.textContent = msg;
        t.style.display = 'block';
        setTimeout(function() { t.style.display = 'none'; }, 2200);
    }

    function shareLink() {
        var shareId = {{ share_id|tojson }};
        var url = window.location.origin + '/f/' + shareId;
        if (navigator.share) {
            navigator.share({ title: 'Fishing Forecast', url: url }).catch(function(){});
        } else if (navigator.clipboard) {
            navigator.clipboard.writeText(url).then(function() {
                showToast('Link copied!');
            });
        } else {
            prompt('Copy this link:', url);
        }
    }

    function shareText() {
        fetch('{{ url_for("api_share_text") }}')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.text) {
                    var url = window.location.origin + '/f/' + data.location_id;
                    var full = data.text + '\n\n' + url;
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(full).then(function() {
                            showToast('Summary copied!');
                        });
                    } else {
                        prompt('Copy this summary:', full);
                    }
                }
            });
    }

    /* ---- Fishing Log (localStorage) ---- */
    var LOG_KEY = 'fishlog_' + {{ (forecast.location_id or '')|tojson }};

    function getLog() {
        try { return JSON.parse(localStorage.getItem(LOG_KEY)) || []; }
        catch(e) { return []; }
    }

    function saveLog(entries) {
        localStorage.setItem(LOG_KEY, JSON.stringify(entries));
    }

    function renderLog() {
        var entries = getLog();
        var container = document.getElementById('fishlog-entries');
        var empty = document.getElementById('fishlog-empty');
        var statsEl = document.getElementById('catch-stats');
        if (!entries.length) {
            container.innerHTML = '';
            empty.style.display = 'block';
            if (statsEl) statsEl.style.display = 'none';
            return;
        }
        empty.style.display = 'none';
        var html = '';
        entries.forEach(function(e, i) {
            html += '<div class="fishlog-entry">';
            html += '<div class="fishlog-entry-main">';
            html += '<strong class="fishlog-species">' + esc(e.species) + '</strong>';
            if (e.size) html += ' <span class="fishlog-size">' + esc(e.size) + '</span>';
            if (e.notes) html += '<p class="fishlog-notes">' + esc(e.notes) + '</p>';
            html += '</div>';
            html += '<div class="fishlog-entry-meta">';
            html += '<span class="fishlog-date">' + esc(e.date) + '</span>';
            html += '<button class="fishlog-del" onclick="deleteLog(' + i + ')" title="Remove" aria-label="Remove this catch entry">&times;</button>';
            html += '</div></div>';
        });
        container.innerHTML = html;
        renderCatchStats(entries);
    }

    function renderCatchStats(entries) {
        var statsEl = document.getElementById('catch-stats');
        if (!statsEl || !entries.length) return;
        statsEl.style.display = 'block';

        // Total catches
        document.getElementById('stat-total').textContent = entries.length;

        // Unique species
        var speciesMap = {};
        entries.forEach(function(e) {
            var sp = e.species.toLowerCase().trim();
            speciesMap[sp] = (speciesMap[sp] || 0) + 1;
        });
        var uniqueSpecies = Object.keys(speciesMap).length;
        document.getElementById('stat-species').textContent = uniqueSpecies;

        // Most caught
        var topSpecies = '—';
        var topCount = 0;
        for (var sp in speciesMap) {
            if (speciesMap[sp] > topCount) {
                topCount = speciesMap[sp];
                topSpecies = sp.charAt(0).toUpperCase() + sp.slice(1);
            }
        }
        document.getElementById('stat-top').textContent = topSpecies;

        // Last catch date
        if (entries[0] && entries[0].date) {
            document.getElementById('stat-recent').textContent = entries[0].date.split(' ')[0];
        }
    }

    function esc(s) {
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    function addLogEntry() {
        var species = document.getElementById('log-species').value.trim();
        if (!species) return;
        var size = document.getElementById('log-size').value.trim();
        var notes = document.getElementById('log-notes').value.trim();
        var entries = getLog();
        var now = new Date();
        entries.unshift({
            species: species,
            size: size,
            notes: notes,
            date: now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        });
        // Keep max 50 entries
        if (entries.length > 50) entries = entries.slice(0, 50);
        saveLog(entries);
        document.getElementById('log-species').value = '';
        document.getElementById('log-size').value = '';
        document.getElementById('log-notes').value = '';
        renderLog();
    }

    function deleteLog(index) {
        var entries = getLog();
        entries.splice(index, 1);
        saveLog(entries);
        renderLog();
    }

    function exportLogCSV() {
        var entries = getLog();
        if (!entries.length) return;
        var rows = [['Date', 'Species', 'Size', 'Notes']];
        entries.forEach(function(e) {
            rows.push([
                '"' + (e.date || '').replace(/"/g, '""') + '"',
                '"' + (e.species || '').replace(/"/g, '""') + '"',
                '"' + (e.size || '').replace(/"/g, '""') + '"',
                '"' + (e.notes || '').replace(/"/g, '""') + '"',
            ]);
        });
        var csv = rows.map(function(r) { return r.join(','); }).join('\n');
        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'fishing-log.csv';
        link.click();
        URL.revokeObjectURL(link.href);
    }

    // Enter key support
    document.getElementById('fishlog-form').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); addLogEntry(); }
    });

    // Render on page load
    renderLog();

    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/sw.js').catch(function(){});
    }

    // Auto-refresh forecast every 30 minutes
    (function() {
        var REFRESH_MS = 30 * 60 * 1000;
        var note = document.getElementById('auto-refresh-note');
        var start = Date.now();
        function updateCountdown() {
            var elapsed = Date.now() - start;
            var remaining = Math.max(0, REFRESH_MS - elapsed);
            var mins = Math.ceil(remaining / 60000);
            if (remaining <= 0) {
                if (note) note.textContent = '— refreshing...';
                window.location.reload();
                return;
            }
            if (note && mins <= 5) {
                note.textContent = '— auto-refresh in ' + mins + ' min';
            }
        }
        setInterval(updateCountdown, 30000);
    })();
    </script>
</body>
</html>
